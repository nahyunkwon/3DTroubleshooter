{% extends 'base.html' %} {% block head %}
<html lang="en">
	<head>
		<title> 3DPFIX </title>
		<!-- utf-8 -->
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<!-- logo -->
		<link href='../static/images/icon.png' type='image/gif' rel='short icon'/>
        <!-- Google font-->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@200;300;400;600&family=Raleway:ital,wght@0,100;0,400;0,800;1,400;1,800&display=swap" rel="stylesheet">
        <!-- customized CSS --> 
        <link href='../static/css/global_layout.css' type='text/css' rel='stylesheet'/>
        <link href='../static/css/global_style.css' type='text/css' rel='stylesheet'/>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.js"></script>

    <script class="datajs" src="../static/js/errDB.js"></script>
    <script class="datajs" src="../static/js/sankey.js"></script>
    <script class="datajs" src="../static/js/sankeyDB.js"></script>

    <link href="../static/css/customList.css" rel="stylesheet" />
    <script src="../static/js/jquery.min.js"></script>
    <link href="../static/css/main.css" rel="stylesheet" />

    <style>
        body {
            background-image: url("../static/images/3DPFIX_BG.png");
        }
    </style>

	</head>
	{% endblock %} {% block body %}
        <!-- Header hat -->
        <div style="height: 5px; background: rgba(218, 28, 92, 1);"></div>
        
        <!-- Header -->
        <div class="flex_container_center" style="flex-direction: row; height:135px;">
            <div id="flex_item_header_logo">
                <a href="index_origin.html" target="_self">
                    <img src="../static/images/logo_3DPFIX.png" alt="George Mason Logo" width="225px" height="90px"/>
                </a>
            </div>
            <div id="flex_item_header_bar"></div>
            <div id="flex_item_header_message">
                <div style="font-size: 24px;font-weight: 100;">
                    Make your 3D Printing troubleshooting easier
                </div>
            </div>
        </div>
        <div class="flex_container_center">
            <div class="flex_container_imageselector_message">
                Step 1. Select an image you want to explore.
            </div>
        </div>

        <!-- Image selector - selector -->
       <div class="flex_container_center">
        <div class="tab">
          {% for i in range(n_img) %}
          <input
            type="image"
            class="tab-links"
            onclick="openTab(event, 'up-img-{{ i }}')"
            id="defaultOpen"
            src="{{ img_format }}{{ img_path[i] | safe }}"
            style="width:230px;height:230px"
            alt=""
          >

          {% endfor %}

        </div>

        {% for i in range(n_img) %}
        <div class="tab-content" id="up-img-{{ i }}">
          <img
            class="uploaded-img"
            src="{{ img_format }}{{ img_path[i] | safe }}"
            alt=""
          />
          <img
            class="uploaded-img-map"
            src="{{ img_format }}{{ img_path_cam[-1][i] | safe }}"
            alt=""
            id="sub-map-all-{{ i }}"
          />

          <div class="div-hidden">
            <img
              class="uploaded-img-map-sub uploaded-img-map-sub-{{ i }}"
              src="{{ img_format }}{{ img_path_cam[0][i] | safe }}"
              alt=""
              id="sub-map-0-{{ i }}"
            />

            <img
              class="uploaded-img-map-sub uploaded-img-map-sub-{{ i }}"
              src="{{ img_format }}{{ img_path_cam[1][i] | safe }}"
              alt=""
              id="sub-map-1-{{ i }}"
            />

            <img
              class="uploaded-img-map-sub uploaded-img-map-sub-{{ i }}"
              src="{{ img_format }}{{ img_path_cam[2][i] | safe }}"
              alt=""
              id="sub-map-2-{{ i }}"
            />

            <img
              class="uploaded-img-map-sub uploaded-img-map-sub-{{ i }}"
              src="{{ img_format }}{{ img_path_cam[3][i] | safe }}"
              alt=""
              id="sub-map-3-{{ i }}"
            />

            <img
              class="uploaded-img-map-sub uploaded-img-map-sub-{{ i }}"
              src="{{ img_format }}{{ img_path_cam[4][i] | safe }}"
              alt=""
              id="sub-map-4-{{ i }}"
            />
          </div>

        <!-- Image selector - selector -->
        <div class="flex_container_center">
            <div class="flex_container_imageselector_message">
                According to the image you selected, your problem can be...
            </div>
        </div>

          {% if init_hide == False %}
          <div class="scrolling-wrapper">
            {% for j in range( card_info[i] | length ) %}
            <div class="card">
              <div class="card-flex">
                <div
                  class="card-top card-top-{{ i }}"
                  id="card-top-{{ i }}-{{ j }}"
                  onclick="showHideMap_click(this.id, '{{ card_info[i][j] }}', '{{ i }}')"
                  onmouseover="showHideMap_on(this.id, '{{ card_info[i][j] }}', '{{ i }}')"
                  onmouseout="showHideMap_off(this.id, '{{ card_info[i][j] }}', '{{ i }}')"

                  <h5>Failure #{{ j+1 }}</h5>
                  <h3>
                    {{ card_info[i][j].split('-')[1] }} ({{ (card_info_prob[i][j] *
                    100) | round(1) }} %)
                  </h3>
                </div>
                <img src="{{ img_format }}{{ img_path_cam[j][i] | safe }}">
                <div class="card-btm">
                  <button
                    class="btn btn-card"
                    name="{{ card_info[i][j].split('-')[1] }}"
                    onclick="addText(this.name);"
                    id="btn-info-{{ i }}-{{ j }}"
                  >
                    What is this?
                  </button>
                  <button
                    class="btn btn-card"
                    name="{{ card_info[i][j].split('-')[1] }}"
                    onclick="showSolution(this.name);
                    document.getElementById('defaultOpen_sol').click();"
                  >
                    How to solve?
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>

        <div class="flex_container_center">
            <div class="flex_container_imageselector_message" style="line-height: 30px; height: 160px; padding-top:20px;">
                Step 2. The "focused" areas displayed above images show the parts that caused your problem. </br>
                If one of the images seems reasonable, click the image to learn how you can solve it. </br>
                In none of them make sense, draw the areas by yourself. </br>
                <div style="margin-top:10px">
                    <span class="button"> Start drawing </span> &nbsp;&nbsp;
                    <span class="button"> Redraw </span> &nbsp;&nbsp;
                    <span class="button"> Finsh drawing </span>
                </div>
            </div>
        </div>


        <!-- Content -->
        <div class="flex_container_center" style="flex-direction:column">
            <div id="flex_innercontainer_menu">
                <div class="flex_innercontainer_menu_item_off"><a href="investigate_definition1.html" style="text-decoration:none;">What's this problem?</a></div>
                <div class="flex_innercontainer_menu_item_on"><a href="index.html" style="text-decoration:none;">Search How to fix</a></div>
                <div class="flex_innercontainer_menu_item_off"><a href="investigate_definition3.html" style="text-decoration:none;">Solution diagram</a></div>
            </div>
            <div id="flex_innercontainer_search">
                <div id="flex_innercontainer_search_left">
                    <div class="flex_innercontainer_search_heading">
                        Step 1. Find an issue that you observed.
                    </div>
                    <div class="search">
                        <input type="text" class="searchTerm" placeholder="What are you looking for?" id="myInput" onkeyup="filterFunction()">
                    </div>

                    <div id="myBtnContainer">

                        <button class="btnList activeList" onclick="filterSelection('all')">All solutions</button>

                    </div>
                </div>
                <div id="flex_innercontainer_search_right">
                    <div class="flex_innercontainer_search_heading">
                        Step 2. Learn solutions, and read suggestions from experts.
                    </div>

                    <div id="solution_placeholder">

                        <fieldset style="height:50px;width:300px">
                            <legend>Filter based on your skill</legend>

                        <div class="diff-checkbox" style="padding-top:20px">
                          <div class="checkbox checkbox-1">
                            <label
                              ><input
                                type="checkbox"
                                rel="diff-0"
                                onchange="diffFilter();"
                                checked="true"
                              />Easy</label
                            >
                          </div>
                          <div class="checkbox checkbox-2">
                            <label
                              ><input
                                type="checkbox"
                                rel="diff-1"
                                onchange="diffFilter();"
                                checked="true"
                              />Normal</label
                            >
                          </div>
                          <div class="checkbox checkbox-3">
                            <label
                              ><input
                                type="checkbox"
                                rel="diff-2"
                                onchange="diffFilter();"
                                checked="true"
                              />Hard</label
                            >
                          </div>
                        </div>

                        </fieldset>
                        <br>
                    </div>

                </div>
            </div>
        </div>
        <!-- Footer hat -->
        <div class="flex_container_center" style="background:rgba(170, 170, 170, 1);height:5px;"></div>
        <!-- Footer -->
        <div class="flex_container_center" style="background: #000;">
            <div id="flex_item_footer">
                <div>Copyright @ 2021, 3DPFix all right reserved</div>
                <div>Last updated: 11/24./2021 <a href="" class="link_black">GitHub</a></div>
            </div>
        </div>



    <script type="text/javascript" id="main-js">
      var boxBorderColor = "springgreen";

      function resetToggle() {
        // Uncheck auto-crop toggle
        let elm = document.getElementById("toggle");
        if (elm.checked == true) {
          elm.click();
        }
      }

      // Tab control
      function openTab(evt, imgID) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-links");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(imgID).style.display = "block";
        evt.currentTarget.className += " active";
      }
      // Tab for solution section
      function openTab_sol(evt, imgID) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content-sol");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-links-sol");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(imgID).style.display = "block";
        evt.currentTarget.className += " active";
      }

      // Image upload Button control
      function showHideDiv(id, set_display = "block") {
        let x = document.getElementById(id);
        if (x.style.display === set_display) {
          x.style.display = "none";
        } else {
          x.style.display = set_display;
        }
      }

      // Default open tab 1
      document.getElementById("defaultOpen").click();
      document.getElementById("defaultOpen_sol").click();

      function addText(inputID) {
        document.getElementById("btm-div-sol").style.display = "none";
        document.getElementById("btm-div-info").style.display = "flex";
        d3.select("#solution-div").selectAll("*").remove();

        d3.select("#errText").text(inputID);

        d3.select("#errInfo").text(errDB[inputID]);
      }

      // Default click error info for issue #1
      document.getElementById("btn-info-0-0").click();

      // Function to compute length of an Object
      Object.size = function (obj) {
        var size = 0,
          key;
        for (key in obj) {
          if (obj.hasOwnProperty(key)) size++;
        }
        return size;
      };

      // Display solutions and thumbs up/down
      function showSolution(inputID) {
        document.getElementById("btm-div-info").style.display = "none";
        document.getElementById("btm-div-sol").style.display = "block";
        d3.select("#errText-sol").text(inputID);

        d3.select("#solution-div").selectAll("*").remove();
      }

      // Card link to sub cam map
      // For mouse over and off

      function showHideMap_on(card_id, card_val, file_idx) {
        let err_idx = parseInt(card_val.split("-")[0]) - 1;
        let map_id = "sub-map-" + err_idx + "-" + file_idx;

        let x = document.getElementById(map_id);
        x.style.display = "block";
        x.style.zIndex = "100";

        let y = document.getElementById(card_id);
        y.style.borderColor = boxBorderColor;
      }

      function showHideMap_off(card_id, card_val, file_idx) {
        let err_idx = parseInt(card_val.split("-")[0]) - 1;
        let map_id = "sub-map-" + err_idx + "-" + file_idx;

        let x = document.getElementById(map_id);

        let y = document.getElementById(card_id);
        if (y.style.borderStyle === "solid") {
          x.style.zIndex = "90";
        } else {
          x.style.display = "none";
          x.style.zIndex = "50";
          y.style.borderColor = "white";
        }
      }

      // For click
      function showHideMap_click(card_id, card_val, file_idx) {
        let err_idx = parseInt(card_val.split("-")[0]) - 1;
        let map_id = "sub-map-" + err_idx + "-" + file_idx;

        let x = document.getElementById(map_id);

        let y = document.getElementById(card_id);
        const style_now = y.style.borderStyle;

        // Reset other selections
        let zz = document.querySelectorAll(".uploaded-img-map-sub-" + file_idx);
        let cc = document.querySelectorAll(".card-top-" + file_idx);
        for (let z = 0; z < zz.length; ++z) {
          zz[z].style.display = "none";
          zz[z].style.zIndex = "50";
        }
        for (let c = 0; c < cc.length; ++c) {
          cc[c].style.borderColor = "white";
          cc[c].style.borderStyle = "dotted";
        }

        if (style_now === "solid") {
          y.style.borderStyle = "dotted";
        } else {
          y.style.borderStyle = "solid";
          y.style.borderColor = boxBorderColor;
          x.style.zIndex = "100";
          x.style.display = "block";
        }
      }
    </script>

    <script type="text/javascript" id="sankey-js">
      var units = "widgets";
      var node_w = 120;
      var node_h = 20;
      var sankey_w = 1400;
      var sankey_h = 1100;
      var extra_width = 200;
      var extra_height = 50;

      // set the dimensions and margins of the graph
      var margin = { top: 10, right: 10, bottom: 10, left: 10 },
        width = sankey_w - margin.left - margin.right,
        height = sankey_h - margin.top - margin.bottom;

      // format variables
      var formatNumber = d3.format(",.0f"), // zero decimal places
        format = function (d) {
          return "(" + formatNumber(d) + " " + units + ")";
        },
        // color = d3.scaleOrdinal(d3.schemeCategory10);
        // color = d3.scaleOrdinal([`#32a852`]);
        color = d3.scaleOrdinal([`forestgreen`]);

      // append the svg object to the body of the page
      var sanSVG = d3
        .select("#sankey-container")
        .append("svg")
        .attr("width", width + margin.left + margin.right + extra_width)
        .attr("height", height + margin.top + margin.bottom + extra_height)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Set the sankey diagram properties
      var sankey = d3
        .sankey()
        .nodeWidth(node_w)
        .nodePadding(40)
        .size([width, height]);

      var sanPath = sankey.link();

      // load the data from "sankey.js"
      sankey.nodes(sankeyDB.nodes).links(sankeyDB.links).layout(32);

      // add in the links
      var sanLink = sanSVG
        .append("g")
        .selectAll(".san-link")
        .data(sankeyDB.links)
        .enter()
        .append("path")
        .attr("class", "san-link")
        .attr("id", function (d, i) {
          d.id = i;
          return "san-link-" + i;
        })
        // .attr("id", function (d) {
        //   return "san-link-" + d.source.name.replace(/\s+/g, '') + "-" + d.target.name.replace(/\s+/g, '')
        // })
        .attr("d", sanPath)
        .style("stroke-width", function (d) {
          return Math.max(1, d.dy);
        })
        .sort(function (a, b) {
          return b.dy - a.dy;
        })
        .on("mouseover", function () {
          d3.select("#" + this.id).style("stroke-opacity", 0.5);
        })
        .on("mouseout", function () {
          d3.select("#" + this.id).style("stroke-opacity", 0.2);
        });

      // add the link titles
      sanLink.append("title").text(function (d) {
        return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value);
      });

      // add in the nodes
      var sanNode = sanSVG
        .append("g")
        .selectAll(".san-node")
        .data(sankeyDB.nodes)
        .enter()
        .append("g")
        .attr("class", "san-node")
        .attr("id", function (d) {
          return "san-g-" + d.name.replace(/\s+/g, "");
        })
        .attr("transform", function (d) {
          return "translate(" + d.x + "," + d.y + ")";
        })
        .call(
          d3
            .drag()
            .subject(function (d) {
              return d;
            })
            .on("start", function () {
              this.parentNode.appendChild(this);
            })
            .on("drag", dragmove)
        )
        .on("mouseover", highlight_node_links)
        .on("mouseout", highlight_node_links);

      // add the rectangles for the nodes
      sanNode
        .append("rect")
        .attr("class", "san-node-rect")
        .attr("height", function (d) {
          // return d.dy;
          return d.dy + 8;
          // return node_h;
        })
        .attr("id", function (d) {
          return "san-node-" + d.name.replace(/\s+/g, "") + "-" + d.node;
        })
        .attr("width", sankey.nodeWidth())
        .style("fill", function (d) {
          return (d.color = color(d.name.replace(/ .*/, "")));
        })
        // .attr("onmouseout", "this.style.fill='forestgreen';")
        // .attr("onmouseover", "this.style.fill='orange';")

        // .on("mouseover", function () {this.style.fill='orange';})

        .style("stroke", function (d) {
          return d3.rgb(d.color).darker(2);
        })
        .append("title")
        .text(function (d) {
          return d.content + "\n\n" + format(d.value / path_w_size);
        });

      // add in the title for the nodes
      sanNode
        .append("text")
        .attr("class", "node-text")
        .attr("x", 4)
        .attr("y", function (d) {
          // return d.dy / 2;
          // return node_h / 2;
          return 10;
        })
        .attr("dy", ".35em")
        // .attr("text-anchor", "end")
        .attr("transform", null)
        // .style('fill', 'white')
        .text(function (d) {
          return d.name;
          // return d.content;
        })
        // .filter(function (d) {
        //   return d.x < width / 2;
        // })
        // .attr("x", 6 + sankey.nodeWidth())
        .attr("text-anchor", "start");
      // .append("tspan")
      // .attr("x", 20)
      // .attr("dx", 10)
      // .attr("dy", 22)
      // .text("line2")

      /////////////////////////////////////////////////

      var sanNodeRects = document.getElementsByClassName("san-node-rect");
      var sanLinkPaths = document.getElementsByClassName("san-link");

      // var sanNodeRects = document.getElementById("san-node-mechanical");
      var nodes_old_h = [];
      for (let j = 0; j < sanNodeRects.length; j++) {
        nodes_old_h.push(sanNodeRects[j].style.height);
      }

      for (let i = 0; i < sanNodeRects.length; i++) {
        sanNodeRects[i].addEventListener("mousedown", function () {
          var panel = this;
          if (panel.style.fill == "orange") {
            panel.style.fill = "forestgreen";

            for (let k = 0; k < sanLinkPaths.length; k++) {
              sanLinkPaths[k].style.stroke = "#000";
            }
          } else {
            for (let j = 0; j < sanNodeRects.length; j++) {
              sanNodeRects[j].style.fill = "forestgreen";
            }
            panel.style.fill = "orange";

            // d3.select("#sankey-content").text(sankeyDB.nodes[this.id.split("-")[3]].content);

            document.getElementById("sankey-content").innerHTML = sankeyDB.nodes[
              this.id.split("-")[3]
            ].content.replace(/(\r\n|\n|\r)/gm, "<br>");

            for (let k = 0; k < sanLinkPaths.length; k++) {
              if (sanLinkPaths[k].style["stroke-opacity"] == "0.5") {
                sanLinkPaths[k].style.stroke = "red";
              } else {
                sanLinkPaths[k].style.stroke = "#000";
              }
            }
          }
        });
      }

      /////////////////////////////////////////////////

      // the function for moving the nodes
      function dragmove(d) {
        d3.select(this).attr(
          "transform",
          "translate(" +
            d.x +
            "," +
            (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) +
            ")"
        );
        sankey.relayout();
        sanLink.attr("d", sanPath);
      }

      //* Function for hightlighting entire path

      function highlight_node_links(node, i) {
        var remainingNodes = [],
          nextNodes = [];

        var stroke_opacity = 0;

        if (d3.select(this).attr("mouseover") == "0") {
          d3.select(this).attr("mouseover", "1");
          stroke_opacity = 0.2;
        } else {
          d3.select(this).attr("mouseover", "0");
          stroke_opacity = 0.5;
        }

        var traverse = [
          {
            linkType: "sourceLinks",
            nodeType: "target",
          },
          {
            linkType: "targetLinks",
            nodeType: "source",
          },
        ];

        traverse.forEach(function (step) {
          node[step.linkType].forEach(function (link) {
            remainingNodes.push(link[step.nodeType]);
            highlight_link(link.id, stroke_opacity);
          });

          while (remainingNodes.length) {
            nextNodes = [];
            remainingNodes.forEach(function (node) {
              node[step.linkType].forEach(function (link) {
                nextNodes.push(link[step.nodeType]);
                highlight_link(link.id, stroke_opacity);
              });
            });

            remainingNodes = nextNodes;
          }
        });
      }

      function highlight_link(id, opacity) {
        d3.select("#san-link-" + id).style("stroke-opacity", opacity);
      }
    </script>

    <script class="mouse-drag-slider">
      // const slider = document.querySelector(".scrolling-wrapper");
      // let mouseDown = false;
      // let startX, scrollLeft;

      // let startDragging = function (e) {
      //   mouseDown = true;
      //   startX = e.pageX - slider.offsetLeft;
      //   scrollLeft = slider.scrollLeft;
      // };
      // let stopDragging = function (event) {
      //   mouseDown = false;
      // };

      // slider.addEventListener("mousemove", (e) => {
      //   e.preventDefault();
      //   if (!mouseDown) {
      //     return;
      //   }
      //   const x = e.pageX - slider.offsetLeft;
      //   const scroll = x - startX;
      //   slider.scrollLeft = scrollLeft - scroll;
      // });

      // // Add the event listeners
      // slider.addEventListener("mousedown", startDragging, false);
      // slider.addEventListener("mouseup", stopDragging, false);
      // slider.addEventListener("mouseleave", stopDragging, false);
    </script>

    <script class="datajs" src="../static/js/customList.js"></script>
    <!--<script class="datajs" src="../static/js/modal.js"></script>-->


{% endblock %}
